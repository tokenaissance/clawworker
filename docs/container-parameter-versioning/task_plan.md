# Task Plan: Container Parameter Versioning Solution

## 问题陈述

### 用户问题
"如何从代码层面解决，当参数修改时，新老版本的启动参数不一致导致线上旧容器和新版本期望的容器行为不一致的问题"

### 具体场景
我们刚才遇到的实际案例：
1. 旧部署：Worker 有 `MOLTBOT_GATEWAY_TOKEN` secret → 容器启动时带 `--token` 参数
2. 用户删除了 secret 并重新部署代码
3. 但旧容器仍在运行，使用旧的环境变量（包含 token）
4. 结果：即使 Worker 代码已更新，容器行为仍然是旧的（要求 token）

## 核心问题

### 问题1：容器生命周期与配置不同步
- Worker 部署 ≠ 容器重启
- 容器可能持续运行（`SANDBOX_SLEEP_AFTER=never`）
- 环境变量在容器启动时固定，运行期间不变

### 问题2：配置变更的即时性
- Worker secrets 更新后，旧容器不知道
- 容器内进程（Gateway）使用启动时的环境变量
- 导致期望行为 vs 实际行为不一致

### 问题3：用户体验差
- 用户更改配置后，需要知道要重新部署
- 容器重启耗时（1-2分钟冷启动）
- 错误信息不清楚（只说缺少 token，不说需要重启）

## 研究阶段

### Phase 1: 分析现有架构
- [ ] 研究 Cloudflare Sandbox 容器生命周期
- [ ] 分析环境变量传递流程（Worker → Container）
- [ ] 查看容器重启触发条件
- [ ] 研究配置热重载可能性

### Phase 2: 调研解决方案
- [ ] 方案A：配置版本控制
- [ ] 方案B：容器自动重启机制
- [ ] 方案C：配置热重载
- [ ] 方案D：显式配置验证
- [ ] 方案E：渐进式配置迁移

## 设计阶段

### 目标
从代码层面提供一个解决方案，使得：
1. 配置更改能够自动生效（或明确告知用户）
2. 新老版本容器行为一致
3. 用户体验友好

### 约束条件
- Cloudflare Sandbox 限制（容器生命周期由平台控制）
- 环境变量在容器启动时设置，运行期间不可变
- 部署和容器重启是分离的操作

## 实现阶段（待规划）

待研究完成后，将设计具体实现方案。

## 当前状态
Phase 1 - 准备开始研究
